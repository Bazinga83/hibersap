                                    ------
                                    Quick Start Guide
                                    ------
                                    Carsten Erker
                                    ------
                                    13.11.2008

Hibersap Quick Start Guide

* Installation

  * Download Hibersap

  * Download dependent libraries (see {{{dependencies.html}Dependencies}})

  * Download SAP Java Connector 3.0 ({{http://service.sap.com/connectors}}) and extract the sapjco3.jar and the sapjco3 native library.

  * Put all jar files (including hibersap.jar) into your project's classpath (or use Maven to declare the dependencies)

  * Put the JCo native library into your library path or into the folder your application will be started
    from (e. g. the root folder of your Eclipse project that contains your main class).

* The first application

  We are going to write a small example application that will call the SAP function module BAPI_SFLIGHT_GETLIST.
  This function is part of a demo application in SAP that offers a simplified flight-booking system.
  The code can be found in project <<<hibersap-examples>>>. The same rules apply for that project, i.e. the native library must
  be in that project's directory, too.

** The function module

  This is the function module's interface in SAP:

+-------------------------------------------------------------------+
FUNCTION BAPI_SFLIGHT_GETLIST.
  IMPORTING
     VALUE(FROMCOUNTRYKEY) LIKE  BAPISFDETA-COUNTRYFR
     VALUE(FROMCITY) LIKE  BAPISFDETA-CITYFROM
     VALUE(TOCOUNTRYKEY) LIKE  BAPISFDETA-COUNTRYTO
     VALUE(TOCITY) LIKE  BAPISFDETA-CITYTO
     VALUE(AIRLINECARRIER) LIKE  BAPISFDETA-CARRID DEFAULT SPACE
     VALUE(AFTERNOON) LIKE  BAPI_AUX-AFTERNOON DEFAULT SPACE
     VALUE(MAXREAD) LIKE  BAPI_AUX-MAXREAD DEFAULT 0
  EXPORTING
     VALUE(RETURN) LIKE  BAPIRET2 STRUCTURE  BAPIRET2
  TABLES
     FLIGHTLIST STRUCTURE  BAPISFLIST
+-------------------------------------------------------------------+

  This function module takes some parameters that represent search criteria to look up flights in SAP's database.
  The matching flights are returned in the FLIGHTLIST table, which contains information such as
  the airline carrier id, a flight connection code and departure/destination data.
  The RETURN structure may be filled by SAP with extra messages like errors, warnings, etc.

  The import parameters are simple types, whereas the export and table parameter are complex data types (ABAP structures).
  The RETURN parameter is of type BAPIRET2, which is a standard structure that can be found in many function modules'
  interfaces and that is not specific to this BAPI.

*--------------------+----------------------+---------------------------------------------------------------+
| <<Component name>> | <<Type>>             | <<Description>>
*--------------------+----------------------+---------------------------------------------------------------+
| TYPE               | Character            | Message type: S Success, E Error, W Warning, I Info, A Abort
*--------------------+----------------------+---------------------------------------------------------------+
| ID                 | Character            | Messages, message class
*--------------------+----------------------+---------------------------------------------------------------+
| NUMBER             | Numeric character    | Messages, message number
*--------------------+----------------------+---------------------------------------------------------------+
| MESSAGE            | Character            | Message text
*--------------------+----------------------+---------------------------------------------------------------+
| LOG_NO             | Character            | Application log: log number
*--------------------+----------------------+---------------------------------------------------------------+
| LOG_MSG_NO         | Numeric character    | Application log: Internal message serial number
*--------------------+----------------------+---------------------------------------------------------------+
| MESSAGE_V1         | Character            | Messages, message variables
*--------------------+----------------------+---------------------------------------------------------------+
| MESSAGE_V2         | Character            | Messages, message variables
*--------------------+----------------------+---------------------------------------------------------------+
| MESSAGE_V3         | Character            | Messages, message variables
*--------------------+----------------------+---------------------------------------------------------------+
| MESSAGE_V4         | Character            | Messages, message variables
*--------------------+----------------------+---------------------------------------------------------------+
| PARAMETER          | Character            | Parameter name
*--------------------+----------------------+---------------------------------------------------------------+
| ROW                | 4-byte integer       | Lines in parameter
*--------------------+----------------------+---------------------------------------------------------------+
| FIELD              | Character            | Field in parameter
*--------------------+----------------------+---------------------------------------------------------------+
| SYSTEM             | Character            | Logical system from which message originates
*--------------------+----------------------+---------------------------------------------------------------+
Structure BAPIRET2

  The FLIGHTLIST table's lines are of type BAPISFLIST which contains the following fields:

*--------------------+----------------------+----------------------------+
| <<Component name>> | <<Type>>             | <<Description>>
*--------------------+----------------------+----------------------------+
| CARRID             | Character            | Airline carrier ID
*--------------------+----------------------+----------------------------+
| CONNID             | Numerical character  | Flight connection code
*--------------------+----------------------+----------------------------+
| FLDATE             | Date                 | Flight date
*--------------------+----------------------+----------------------------+
| AIRPFROM           | Character            | Airport of departure
*--------------------+----------------------+----------------------------+
| AIRPTO             | Character            | Destination airport
*--------------------+----------------------+----------------------------+
| DEPTIME            | Time                 | Departure time
*--------------------+----------------------+----------------------------+
| SEATSMAX           | 4-byte integer       | Maximum capacity
*--------------------+----------------------+----------------------------+
| SEATSOCC           | 4-byte integer       | Occupied seats
*--------------------+----------------------+----------------------------+
Structure BAPISFLIST

** The BAPI class

  To call a function module from a Java application using Hibersap, we have to write a <BAPI class> that acts as an adapter to JCo.
  The BAPI class is a simple Java class with a number of fields representing the BAPI's import, export and table parameters.
  In case the BAPI parameter being a scalar parameter, the Java field itself is of a simple Java type.
  In the case of a structure parameter, the Java field's type has to be a complex type, too.
  A table parameter maps to a Collection of a complex type.

  All setup related to the function module's interface is done via Java annotations.
  A BAPI class is defined using the Hibersap class annotation <<<@Bapi>>>,
  which has a name argument specifying the name of the SAP function module we want to call.
  (All Hibersap annotations can be found in the package org.hibersap.annotations.)

+----------------------------------+
package org.hibersap.examples.flightlist;

import java.util.List;
import org.hibersap.*;

@Bapi("BAPI_SFLIGHT_GETLIST")
public class FlightListBapi
{
  ...
}
+----------------------------------+

  The fields that are mapped to the function module's parameters are annotated with the
  <<<@Import>>>, <<<@Export>>> or <<<@Table>>> annotations.
  Additionally, we have to specify the function module's field name
  to which it relates, using the <<<@Parameter>>> annotation.
  The <<<@Parameter>>>'s second argument, <<<type>>>, tells Hibersap if the parameter has a simple or a complex structure type.
  The enumeration <<<ParameterType>>> defines possible values, the default type for element <<<type>>> being SIMPLE.
  In most cases we have to specify a parameter's name only. Since table parameters always represent
  a table of complex types, any parameter type argument will be ignored by Hibersap.

+-----------------------------------------------------------------+
    @Import
    @Parameter("FROMCOUNTRYKEY")
    private final String fromCountryKey;

    @Import
    @Parameter("FROMCITY")
    private final String fromCity;

    @Import
    @Parameter("TOCOUNTRYKEY")
    private final String toCountryKey;

    @Import
    @Parameter("TOCITY")
    private final String toCity;

    @Import
    @Parameter("AIRLINECARRIER")
    private final String airlineCarrier;

    @Import
    @Parameter("AFTERNOON")
    @Convert(converter = BooleanConverter.class)
    private final boolean afternoon;

    @Import
    @Parameter("MAXREAD")
    private final int maxRead;

    @Export
    @Parameter(value="RETURN", type = ParameterType.STRUCTURE)
    private BapiRet2 returnData;

    @Table
    @Parameter("FLIGHTLIST")
    private List<Flight> flightList;
+-----------------------------------------------------------------+

  The Java type of each simple field is related to the SAP field's data type.
  Hibersap relies on the Java Connector's conversion scheme:

*-----------------+----------------------------+--------------------+
| <<ABAP type>>   | <<Description>>            | <<Java type>>
*-----------------+----------------------------+--------------------+
| C               | Character                  | java.lang.String
*-----------------+----------------------------+--------------------+
| N               | Numerical character        | java.lang.String
*-----------------+----------------------------+--------------------+
| D               | Date                       | java.lang.Date
*-----------------+----------------------------+--------------------+
| T               | Time                       | java.lang.Date
*-----------------+----------------------------+--------------------+
| X               | Byte field                 | byte[]
*-----------------+----------------------------+--------------------+
| P               | Packed number              | java.lang.BigDecimal
*-----------------+----------------------------+--------------------+
| I               | 4-byte integer             | int
*-----------------+----------------------------+--------------------+
| F               | Floating point number      | double
*-----------------+----------------------------+--------------------+
| STRING          | Variable-length character  | java.lang.String
*-----------------+----------------------------+--------------------+
| XSTRING         | Variable-length byte field | byte[]
*-----------------+----------------------------+--------------------+
SAP Java Connector type conversion

  Hibersap allows to convert a parameter's data type to any Java type and vice versa.
  E. g., ABAP does not have a boolean type. Usually a boolean in ABAP is represented by a
  character field of length 1. A parameter is true if it equals to 'X', false if it is empty.

  The <<<@Convert>>> annotation on the field <<<afternoon>>> in the listing above tells Hibersap
  to use a Converter of type <<<BooleanConverter>>> to convert the parameter AFTERNOON to a
  Java boolean value.
  It is easy to write your own converter by implementing the <<<org.hibersap.conversion.Converter>>> interface.

  To conclude the example, we write a constructor which takes all the import parameters as arguments,
  initializing the corresponding fields.

+----------------------------------------------------+
    public FlightListBapi( String fromCountryKey,
                           String fromCity,
                           String toCountryKey,
                           String toCity,
                           String airlineCarrier,
                           boolean afternoon,
                           int maxRead )
    {
        this.fromCountryKey = fromCountryKey;
        this.fromCity = fromCity;
        this.toCountryKey = toCountryKey;
        this.toCity = toCity;
        this.airlineCarrier = airlineCarrier;
        this.afternoon = afternoon;
        this.maxRead = maxRead;
    }
+----------------------------------------------------+

  Finally, we should add a getter method for each field.
  Hibersap does not need setter methods, because all fields are set using reflection.
  We could of course add additional fields and methods if needed.

+----------------------------------------------------+
    public boolean getAfternoon()
    {
        return this.afternoon;
    }

    ...
+----------------------------------------------------+

  [Note] There is one constraint in the current version of Hibersap you should take into account:
         The mapping between SAP parameters and Java classes works as expected only if the SAP function module
         follows the BAPI standard, this means:

         * No deep tables (i. e. tables in tables) are not supported.

         * Tables in import and export parameters are not supported.

         * Changing parameters can not be mapped.

         * ABAP exceptions are simply converted to <<<HibersapException>>>.

         []

  []


** Structure classes

  There are two more classes we have to write:
  One for the complex export parameter RETURN, which is named BapiRet2, after the SAP data type.
  It is another annotated simple Java class with fields related to some of the function module's parameter.
  To keep the example simple, we do not map all the fields of the RETURN parameter.

+----------------------------------------------------------------------------+
package org.hibersap.bapi;

import org.hibersap.annotations.*;

@BapiStructure
public class BapiRet2
{
    @Parameter("TYPE")
    @Convert(converter = CharConverter.class)
    private char type;

    @Parameter("ID")
    private String id;

    @Parameter("NUMBER")
    private String number;

    @Parameter("MESSAGE")
    private String message;


    public char getType()
    {
        return this.type;
    }

    public String getId()
    {
        return this.id;
    }

    public String getNumber()
    {
        return this.number;
    }

    public String getMessage()
    {
        return this.message;
    }
}
+----------------------------------------------------------------------------+

  The class is annotated with <<<@BapiStructure>>> to tell Hibersap that it maps to
  a complex parameter on the SAP side. Each particular field is annotated with the
  already known <<<@Parameter>>> annotation that defines the name of the corresponding structure field.
  The BapiRet2 class is already part of Hibersap, since this structure is used by a lot of
  SAP function modules. This means, you don't have to implement it.

  Second, there is a Java class that Hibersap will map to the table parameter FLIGHTLIST,
  which in our example is simply called <<<Flight>>>.
  The table FLIGHTLIST will be filled by SAP with the flight information matching our request.

+----------------------------------------------------------------------------+
package org.hibersap.examples.flightlist;

import java.util.Date;
import org.hibersap.*;

@BapiStructure
public class Flight
{
    @Parameter("CARRID")
    private String carrierId;

    @Parameter("CONNID")
    private String connectionId;

    @Parameter("AIRPFROM")
    private String airportFrom;

    @Parameter("AIRPTO")
    private String airportTo;

    @Parameter("FLDATE")
    private Date flightDate;

    @Parameter("DEPTIME")
    private Date departureTime;

    @Parameter("SEATSMAX")
    private int seatsMax;

    @Parameter("SEATSOCC")
    private int seatsOccupied;

    public String getAirportFrom()
    {
        return this.airportFrom;
    }

    public String getAirportTo()
    {
        return this.airportTo;
    }

    public String getCarrierId()
    {
        return this.carrierId;
    }

    public String getConnectionId()
    {
        return this.connectionId;
    }

    public Date getDepartureTime()
    {
        return DateUtil.joinDateAndTime( flightDate, departureTime );
    }

    public Date getFlightDate()
    {
        return flightDate;
    }

    public int getSeatsMax()
    {
        return this.seatsMax;
    }

    public int getSeatsOccupied()
    {
        return this.seatsOccupied;
    }
}
+----------------------------------------------------------------------------+

  Please note that the method <<<getDepartureTime()>>> does not simply return the field <<<departureTime>>>
  but calls a utility method DateUtil.joinDateAndTime(). This is done here because ABAP does not know a
  data type that contains date and time, rather a timestamp is separated into two fields, one
  of type Date, the other of type Time. Therefore the Java Connector returns a <<<java.util.Date>>> for the SAP
  date field containing the date fraction (date at 00:00:00,000) and another <<<java.util.Date>>> for the time
  field containing the time fraction (i.e. Jan. 1st, 1970 plus time).

** Configuration

  To configure Hibersap, you need to specify a name for the <<<SessionFactory>>> (see next section),
  plus the properties for the Java Connector.
  There are two possibilities to configure Hibersap: Either you define the properties in a file named <<<hibersap.properties>>> 
  or in an <<<META-INF/hibersap.xml>>> XML file. Both of which have to be detectable in our application's classpath. Using an XML file is the preferred
  way to configure your application.

  In the example we use a minimum set of JCo properties to be able to connect to the back-end SAP system.

** XML file configuration

  The format of the XML configuration file is heavily inspired by JPA's <<<persistence.xml>>>.

+----------------------------------------------------------------------------+
<?xml version="1.0" encoding="UTF-8"?>
<hibersap>
  <session-factory name="A12">
    <context>org.hibersap.execution.jco.JCoContext</context>

    <properties>
      <property name="jco.client.client" value="800" />
      <property name="jco.client.user" value="sapuser" />
      <property name="jco.client.passwd" value="password" />
      <property name="jco.client.lang" value="en" />
      <property name="jco.client.ashost" value="10.20.80.76" />
      <property name="jco.client.sysnr" value="00" />
      <property name="jco.destination.pool_capacity" value="1" />
    </properties>

    <class>org.hibersap.examples.flightlist.FlightListBapi</class>
    <class>org.hibersap.examples.flightdetail.FlightDetailBapi</class>
  </session-factory>
</hibersap>
+----------------------------------------------------------------------------+

** Properties file configuration

+----------------------------------------------------------------------------+
# The session factory name
hibersap.session_factory_name=A12

# Java Connector settings
hibersap.jco.client.client=800
hibersap.jco.client.user=sapuser
hibersap.jco.client.passwd=password
hibersap.jco.client.lang=en
hibersap.jco.client.ashost=10.20.80.76
hibersap.jco.client.sysnr=00
jco.destination.pool_capacity=1

# Mapped classes
hibersap.bapi_class.0=org.hibersap.examples.flightlist.FlightListBapi
hibersap.bapi_class.1=org.hibersap.examples.flightdetail.FlightDetailBapi
+----------------------------------------------------------------------------+

** Manual configuration

  You will find constants for Hibersap's property names in the class <<<Environment>>>,
  whereas names for JCo properties are specified in the interface <<<JCoProperties>>>.

  Using a properties file it is not possible to define more than one SAP system.
  Currently, you have to specify these properties programmatically, using the setProperty() method
  of Hibersap's <<<AnnotationConfiguration>>> class.
  This method can be used to set properties that are not specified in a <<<hibersap.properties>>> file,
  but can also be used to overwrite properties from the properties file.
  This can be very convenient for a test setup, because you don't have to care for different
  properties files to be in place for different back-end systems, like test, integration and production.


** Calling a function module

  Hibersap's API is very close to Hibernate.
  There is the notion of a <<<SessionFactory>>> which should be created only once in an application,
  because it is rather expensive to create.
  One <<<SessionFactory>>> is needed for each SAP system which is used by the application.

  The <<<SessionFactory>>> is responsible for creating <<<Session>>>s.
  A <<<Session>>> represents a connection to the SAP system. The first time we call a function module
  on a <<<Session>>>, Hibersap gets a connection from the underlying connection pool.
  When closing a session, the connection is returned to the pool. Therefore you have to take care
  always to close the session, preferably in a <<<finally>>> block, else the connection pool may
  get exhausted very fast.

  The following function configures a Hibersap <<<SessionFactory>>>.
  First, an instance of type <<<AnnotationConfiguration>>> has to be created.
  Then we add our BAPI Class to the configuration (if it is not already listed in the configuration, see examples above).
  If needed, we could now set or overwrite properties using the <<<configuration.setProperty()>>>.
  Finally, we build the <<<SessionFactory>>>.
  In a real application this should be done once, reusing the <<<SessionFactory>>> throughout the
  application's lifetime.

+--------------------------------------------------------------------------------------------------------------+
public SessionFactory createSessionFactory()
{
    AnnotationConfiguration configuration = new AnnotationConfiguration();
    configuration.setProperty( Environment.SESSION_FACTORY_NAME, "F46" );
    configuration.addAnnotatedClass( MyBapi.class );
    return configuration.buildSessionFactory();
}
+--------------------------------------------------------------------------------------------------------------+

  Now it is time to call the function module in SAP.
  After creating the <<<SessionFactory>>> and opening a new <<<Session>>>, we create an instance of our
  BAPI Class, passing all parameters needed to execute the function as Constructor arguments.
  Then we simply call the <<<execute()>>> method on the <<<Session>>>, passing the BAPI class,
  which actually performs the call to SAP. Now the <<<flightListBapi>>> object is enriched with all the
  values which the function module returned and which we have mapped in our BAPI Class.

+--------------------------------------------------------------------------------------------------------------+
public void showFlightList()
{
    SessionFactory sessionFactory = createSessionFactory();

    Session session = sessionFactory.openSession();
    try
    {
        FlightListBapi flightList = new FlightListBapi( "DE", "Frankfurt", "DE", "Berlin", null, false, 10 );
        session.execute( flightList );
        showResult( flightList );
    }
    finally
    {
        session.close();
    }
}
+--------------------------------------------------------------------------------------------------------------+

  To see the result of the function call, we simply print the BAPI class' fields to the console in the
  <<<showResult()>>> method:

+--------------------------------------------------------------------------------------------------------------+
private void showResult( FlightListBapi flightList )
{
    System.out.println( "AirlineId: " + flightList.getFromCountryKey() );
    System.out.println( "FromCity: " + flightList.getFromCity() );
    System.out.println( "ToCountryKey: " + flightList.getToCountryKey() );
    System.out.println( "ToCity: " + flightList.getToCity() );
    System.out.println( "AirlineCarrier: " + flightList.getAirlineCarrier() );
    System.out.println( "Afternoon: " + flightList.getAfternoon() );
    System.out.println( "MaxRead: " + flightList.getMaxRead() );

    System.out.println( "\nFlightData" );
    List<Flight> flights = flightList.getFlightList();
    for ( Flight flight : flights )
    {
        System.out.print( "\t" + flight.getAirportFrom() );
        System.out.print( "\t" + flight.getAirportTo() );
        System.out.print( "\t" + flight.getCarrierId() );
        System.out.print( "\t" + flight.getConnectionId() );
        System.out.print( "\t" + flight.getSeatsMax() );
        System.out.print( "\t" + flight.getSeatsOccupied() );
        System.out.println( "\t" + flight.getDepartureTime() );
    }

    System.out.println( "\nReturn" );
    BapiRet2 returnStruct = flightList.getReturnData();
    System.out.println( "\tMessage: " + returnStruct.getMessage() );
    System.out.println( "\tNumber: " + returnStruct.getNumber() );
    System.out.println( "\tType: " + returnStruct.getType() );
    System.out.println( "\tId: " + returnStruct.getId() );
}
+--------------------------------------------------------------------------------------------------------------+

  In the example, we are looking for all flights from Frankfurt to Berlin.
  The result should look like follows, in this example, there were two flights found.

+--------------------------------------------------------------------------------------------------------------+
AirlineId: DE
FromCity: Frankfurt
ToCountryKey: DE
ToCity: Berlin
AirlineCarrier:
Afternoon: false
MaxRead: 10

FlightData
	FRA	SXF	LH	2402	220	191	Thu Dec 30 10:30:00 CET 2010
	FRA	SXF	LH	2402	220	207	Fri Dec 31 10:30:00 CET 2010

Return
	Message:
	Number: 000
	Type: S
	Id:
+--------------------------------------------------------------------------------------------------------------+

  If there were no flights found, the <<<return>>> field will contain the following data returned by SAP:

+--------------------------------------------------------------------------------------------------------------+
Return
	Message: No corresponding flights found
	Number: 150
	Type: E
	Id: BC_BOR
+--------------------------------------------------------------------------------------------------------------+


